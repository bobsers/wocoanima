import subprocess
import re
import sys

print("[-] Starting Exploit...")

try:
    # 启动 readflag 程序
    p = subprocess.Popen(
        ["/readflag"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=0,
    )  # Unbuffered

    buffer = ""
    solved = False

    while True:
        # 读取输出
        char = p.stdout.read(1)
        if not char:
            break
        buffer += char

        # 寻找算式
        if not solved and "((((" in buffer:
            # 提取最后一行
            lines = buffer.split("\n")
            for line in lines:
                if line.strip().startswith("((((") and "))" in line:
                    expr = line.strip()
                    print(f"[+] Found expression: {expr}")
                    # 计算
                    try:
                        # eval is safe for this math expr
                        # Python's eval might need integer adjustment?
                        # The expr is like (((1)+(2))-(3))...
                        # Python handles this fine.
                        val = eval(expr)
                        print(f"[+] Calculated: {val}")
                        p.stdin.write(f"{val}\n")
                        p.stdin.flush()
                        solved = True
                    except Exception as e:
                        print(f"[-] Calc error: {e}")
                    break

    p.wait()
    print("[-] Process finished.")
    print("[-] Output Buffer:")
    print(buffer)

except Exception as e:
    print(f"[-] Exploit crashed: {e}")
